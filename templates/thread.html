<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thread</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200..800&display=swap");

      body {
        background-color: #ffffff;
        color: #333333;
        font-family: "Plus Jakarta Sans", sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        overflow: hidden;
        transition: background-color 0.3s;
      }

      .sidebar {
        background-color: #f5f5f5;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: width 0.3s, background-color 0.5s;
      }

      .sidebar-collapsed {
        width: 4.5rem;
      }

      .sidebar-expanded {
        width: 16rem;
      }

      .sidebar .sidebar-item span {
        transition: opacity 0.3s, margin 0.3s;
      }

      .sidebar-collapsed .sidebar-item span {
        display: none;
      }

      .sidebar-expanded .sidebar-item span {
        display: inline;
        margin-left: 1rem;
      }

      .sidebar .sidebar-item {
        padding: 0.5rem;
        display: flex;
        align-items: center;
        cursor: pointer;
        color: #333333;
      }

      .sidebar .sidebar-item i {
        margin-right: 1rem;
        transition: margin 0.3s;
      }

      .sidebar-collapsed .sidebar-item i {
        margin-right: 0;
      }

      .sidebar .footer {
        margin-top: auto;
      }

      .main-container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
        transition: background-color 0.3s;
      }

      .toggle-button {
        position: absolute;
        top: 10px;
        left: 4rem;
        background-color: transparent;
        color: #333333;
        border: none;
        padding: 8px;
        border-radius: 5px;
        cursor: pointer;
        transition: left 0.3s;
      }

      .toggle-button i {
        font-size: 20px;
      }

      .sidebar-collapsed ~ .toggle-button {
        margin-top: 30rem;
        left: 1rem;
      }

      .sidebar-expanded ~ .toggle-button {
        left: 13rem;
      }

      .thread-header {
        font-size: 24px;
        margin-top: 20px;
        margin-bottom: 20px;
        color: #333333;
        text-align: center;
      }

      .thread-container {
        background-color: #ffffff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 800px;
        margin: auto;
        display: flex;
        flex-direction: column;
        border-color: #e0e0e0;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      .message {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 10px;
        background-color: #f5f5f5;
        word-wrap: break-word;
        animation: fadeIn 0.5s ease-in-out;
        color: #333333;
      }

      .message.is-user {
        background-color: #e6f2ff;
        color: #333333;
        text-align: right;
      }

      .message.is-bot {
        background-color: #f5f5f5;
        color: #333333;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .input-container {
        display: flex;
        margin-top: 20px;
      }

      .input-container input {
        flex-grow: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #e0e0e0;
        background-color: #ffffff;
        color: #333333;
      }

      .input-container button {
        margin-left: 10px;
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        background-color: #4a90e2;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div
      id="sidebar"
      class="sidebar sidebar-collapsed bg-202222; flex flex-col justify-between p-4 shadow-2xl"
    >
      <div>
        <!-- <div class="flex items-center justify-center mb-6">
          <img src="/static/Logo.png" alt="perplexity logo" class="w-6 h-6" />
        </div> -->
        <nav>
          <a
            href="/"
            class="sidebar-item flex items-center justify-center md:justify-start text-gray-400 hover:text-black py-2 mb-4"
          >
            <i class="fas fa-home"></i>
            <span class="hidden md:inline">Home</span>
          </a>
          <a
            href="/dashboard"
            class="sidebar-item flex items-center justify-center md:justify-start text-gray-400 hover:text-black py-2 mb-4"
          >
            <i class="fas fa-compass"></i>
            <span class="hidden md:inline">Dashboard</span>
          </a>
          <a
            href="/library"
            class="sidebar-item flex items-center justify-center md:justify-start text-gray-400 hover:text-black py-2 mb-4"
          >
            <i class="fas fa-book"></i>
            <span class="hidden md:inline">Library</span>
          </a>
        </nav>
      </div>
      <div class="flex flex-col items-center md:items-start mb-4">
        <button
          onclick="logOut()"
          class="sidebar-item flex items-center justify-center md:justify-start text-gray-400 hover:text-white py-2 mb-4"
        >
          <i class="fas fa-sign-out-alt"></i>
          <span class="hidden md:inline">Log out</span>
        </button>
      </div>
    </div>
    <button class="toggle-button" onclick="toggleSidebar()">
      <i class="fas fa-arrow-circle-right"></i>
    </button>
    <div class="main-container">
      <div class="thread-header" id="thread-title"></div>
      <div class="thread-container" id="thread-container"></div>
      <div class="input-container">
        <input
          type="text"
          id="new-message"
          placeholder="Type your message here..."
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const threadId = {{ thread_id }};
      document.addEventListener('DOMContentLoaded', fetchThread);

      function fetchThread() {
          fetch(`/continue_thread/${threadId}`)
              .then(response => response.json())
              .then(data => {
                  if (data.error) {
                      alert(data.error);
                  } else {
                      const thread = data.thread;
                      document.getElementById('thread-title').textContent = thread.title;
                      const threadContainer = document.getElementById('thread-container');
                      thread.session_history.forEach(message => {
                          const messageDiv = document.createElement('div');
                          messageDiv.classList.add('message');
                          if (message.role === 'user') {
                              messageDiv.classList.add('is-user');
                          } else {
                              messageDiv.classList.add('is-bot');
                          }
                          messageDiv.innerHTML = `<p>${message.content}</p>`;
                          threadContainer.appendChild(messageDiv);
                      });
                  }
              })
              .catch(error => {
                  console.error('Error fetching thread:', error);
              });
      }

      function sendMessage() {
          const newMessageInput = document.getElementById('new-message');
          const messageContent = newMessageInput.value.trim();
          if (!messageContent) {
              return;
          }

          const messageDiv = document.createElement('div');
          messageDiv.classList.add('message', 'is-user');
          messageDiv.innerHTML = `<p>${messageContent}</p>`;
          document.getElementById('thread-container').appendChild(messageDiv);
          newMessageInput.value = '';

          fetch(`/continue_conversation/${threadId}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrf_token')
              },
              body: JSON.stringify({ message: messageContent })
          })
          .then(response => response.json())
          .then(data => {
              if (data.bot_response) {
                  const botMessageDiv = document.createElement('div');
                  botMessageDiv.classList.add('message', 'is-bot');
                  botMessageDiv.innerHTML = `<p>${data.bot_response}</p>`;
                  document.getElementById('thread-container').appendChild(botMessageDiv);
              }
          })
          .catch(error => {
              console.error('Error sending message:', error);
          });
      }

      function toggleSidebar() {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('sidebar-collapsed');
          sidebar.classList.toggle('sidebar-expanded');
          const spans = sidebar.querySelectorAll('.sidebar-item span');
          spans.forEach(span => {
              if (sidebar.classList.contains('sidebar-collapsed')) {
                  span.style.display = 'none';
              } else {
                  setTimeout(() => {
                      span.style.display = 'inline';
                  }, 300);
              }
          });
      }

      function logOut() {
          console.log("Logging out...");
          fetch('/logout', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': getCookie('csrf_token')
              }
          })
          .then(response => {
              console.log("Response received:", response);
              if (response.redirected) {
                  window.location.href = response.url;
              } else {
                  alert("Logout failed.");
              }
          })
          .catch(error => {
              console.error('Error logging out:', error);
              alert("Logout failed.");
          });
      }

      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
    </script>
  </body>
</html>
